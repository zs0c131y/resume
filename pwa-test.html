<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PWA Installation Test</title>
    <style>
      body {
        font-family: "Inter", system-ui, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        color: #333;
        background-color: #f5f5f5;
        max-width: 800px;
        margin: 0 auto;
      }

      h1 {
        color: #ff6b6b;
      }

      .card {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }

      code {
        background-color: #eee;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: monospace;
      }

      button {
        background-color: #ff6b6b;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
      }

      button:hover {
        background-color: #f05252;
      }

      .log {
        background-color: #2d2d2d;
        color: #fff;
        padding: 15px;
        border-radius: 4px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>PWA Installation Test</h1>

    <div class="card">
      <h2>Installation Status</h2>
      <p id="install-status">Checking installation status...</p>
      <button id="install-button" style="display: none">Install App</button>
    </div>

    <div class="card">
      <h2>Display Mode</h2>
      <p id="display-mode">Checking display mode...</p>
    </div>

    <div class="card">
      <h2>Service Worker</h2>
      <p id="sw-status">Checking service worker status...</p>
    </div>

    <div class="card">
      <h2>Event Log</h2>
      <div id="log" class="log"></div>
    </div>

    <script>
      // Logger
      const log = document.getElementById("log");
      function logEvent(message) {
        const timestamp = new Date().toLocaleTimeString();
        log.innerHTML += `[${timestamp}] ${message}\n`;
        log.scrollTop = log.scrollHeight;
      }

      // Get elements
      const installButton = document.getElementById("install-button");
      const installStatus = document.getElementById("install-status");
      const displayMode = document.getElementById("display-mode");
      const swStatus = document.getElementById("sw-status");

      // Check display mode
      function checkDisplayMode() {
        if (window.matchMedia("(display-mode: standalone)").matches) {
          displayMode.textContent =
            "App is running in standalone mode (installed)";
          logEvent("Running in standalone mode");
        } else if (window.matchMedia("(display-mode: fullscreen)").matches) {
          displayMode.textContent = "App is running in fullscreen mode";
          logEvent("Running in fullscreen mode");
        } else if (window.matchMedia("(display-mode: minimal-ui)").matches) {
          displayMode.textContent = "App is running in minimal-ui mode";
          logEvent("Running in minimal-ui mode");
        } else if (window.navigator.standalone === true) {
          // iOS detection
          displayMode.textContent =
            "App is running in standalone mode on iOS (installed)";
          logEvent("Running in standalone mode (iOS)");
        } else {
          displayMode.textContent =
            "App is running in browser mode (not installed)";
          logEvent("Running in browser mode");
        }
      }

      // Check Service Worker
      function checkServiceWorker() {
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker
            .getRegistration()
            .then((registration) => {
              if (registration) {
                swStatus.textContent = `Service Worker registered with scope: ${registration.scope}`;
                logEvent(`Service Worker registered: ${registration.scope}`);
              } else {
                swStatus.textContent = "No Service Worker registration found";
                logEvent("No Service Worker registration found");
              }
            })
            .catch((error) => {
              swStatus.textContent = `Error checking Service Worker: ${error}`;
              logEvent(`Service Worker error: ${error}`);
            });
        } else {
          swStatus.textContent =
            "Service Workers are not supported in this browser";
          logEvent("Service Workers not supported");
        }
      }

      // Handle installation
      let deferredPrompt;
      window.addEventListener("beforeinstallprompt", (e) => {
        logEvent("beforeinstallprompt event fired");
        // Prevent Chrome from automatically showing the prompt
        e.preventDefault();
        // Stash the event so it can be triggered later
        deferredPrompt = e;

        // Update UI to notify the user they can install the PWA
        installButton.style.display = "block";
        installStatus.textContent = "App is ready to install";

        // Add click handler for the install button
        installButton.addEventListener("click", async () => {
          logEvent("Install button clicked");

          // Hide the install button
          installButton.style.display = "none";

          // Show the install prompt
          deferredPrompt.prompt();

          // Wait for the user to respond to the prompt
          const { outcome } = await deferredPrompt.userChoice;
          logEvent(`User response to install prompt: ${outcome}`);

          if (outcome === "accepted") {
            installStatus.textContent = "Installation accepted";
          } else {
            installStatus.textContent = "Installation declined";
            installButton.style.display = "block";
          }

          // Clear the deferredPrompt variable
          deferredPrompt = null;
        });
      });

      // Handle successful installation
      window.addEventListener("appinstalled", (event) => {
        logEvent("appinstalled event fired");
        installStatus.textContent = "App was successfully installed";
        installButton.style.display = "none";

        // Re-check display mode after installation
        setTimeout(checkDisplayMode, 1000);
      });

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        logEvent("Page loaded");
        checkDisplayMode();
        checkServiceWorker();

        if (!deferredPrompt) {
          if (
            window.matchMedia("(display-mode: standalone)").matches ||
            window.navigator.standalone === true
          ) {
            installStatus.textContent = "App is already installed";
          } else {
            installStatus.textContent =
              "App can be installed, but the browser hasn't triggered the install prompt";
            logEvent("No install prompt available");
          }
        }
      });

      // Check if standalone mode changed (useful for debugging)
      window
        .matchMedia("(display-mode: standalone)")
        .addEventListener("change", (e) => {
          logEvent(`Display mode changed. Standalone: ${e.matches}`);
          checkDisplayMode();
        });
    </script>
  </body>
</html>
